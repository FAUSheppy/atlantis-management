<head>
    {% include "head.html" %}
</head>
<body>
    <div class="navbar">
        <div style="float: left;" class="navbar-el">{{ user or  "" }}</div>
        <a href="/oauth2/sign_out" class="navbar-el">Logout</a>
    </div>
    <div class="main-container">
        {% for service_name, service in services.items() %}
            <div class="seperator">
            <h3 style="margin-left: 15px;">{{ services.name }}</h3>
            <hr>
            </div>
            {% for hook in service.hook_operations %}
                {% if hook.client %}
                    <div id="status-target-{{ hook.name }}">

                    </div>
                    <button onclick="query_{{ service_name }}_{{ hook.name }}()">
						{{ hook.name }}
					</button>
                    <script>
                        async function query_{{ service_name }}_{{ hook.name }}(){

                            {% if hook.location.multi_url %}
                            urls = [ {% for h_url in hook.location.url %}
                                        "{{ h_url | safe }}" + "?" + new URLSearchParams({{ hook.location.args_f() | safe }}),
                                     {% endfor %}
                            ]
                            {% else %}
                            urls = ["{{ hook.location.url | safe }}" + "?" + new URLSearchParams({{ hook.location.args_f() | safe }})]
                            {% endif %}

                            urls.forEach( async (url) => {
                                    let response = await fetch(url)
                                }
                            )
                        }
                        {% if hook.status_url %}
                        async function status_update_{{ service_name }}_{{ hook.name }}(){
                            let url = "{{ hook.status_url }}"
                            let response = await fetch(url)
                            let text = await response.text()
                            let target = document.getElementById("status-target-{{ hook.name }}")
                            target.innerHTML = text

                        }
                        setInterval(status_update_{{ service_name }}_{{ hook.name }}, 1000)
                        {% endif %}
                    </script>
                {% else %}
                    <div class="m-3 action-container">
                        <button onclick="query_{{ service_name }}_{{ hook.name }}()">
							{{ hook.name }}
						</button>
                        <div id="status-target-{{ hook.name }}">

                        </div>
                        <script>
                            async function query_{{ service_name }}_{{ hook.name }}(){
                                let url = "/hook-relay?service={{ service.clean_name() }}&operation={{ hook.name }}"
                                let response = await fetch(url, { 
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                    body: JSON.stringify({}),
                                })
                                // let data = await response.json();
                                status_update_{{ hook.name }}()
                            }
                            async function status_update_{{ service_name }}_{{ hook.name }}(){
                                let url = "/endpoints?service={{ service.clean_name() }}&endpoint={{ hook.name }}"
                                let response = await fetch(url)
                                let data = await response.json();
                                let target = document.getElementById("status-target-{{ hook.name }}")
                                if(!data.title){
                                    target.innerHTML = "No status info available"
                                }else{
                                    target.innerHTML = data.title + " " + data.message
                                }
                            }
                            setInterval(status_update_{{ service_name }}_{{ hook.name }}, 1000)
                        </script>
                    </div>
                {% endif %}
            {% endfor %}
            <div>
            </div>
        {% endfor %}
    </div>
</body>
